name: ðŸ§ª Test GitHub Actions Setup

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test Type'
        required: true
        default: 'basic'
        type: choice
        options:
        - basic
        - secrets
        - opentofu

jobs:
  basic-test:
    name: ðŸ” Basic Environment Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'basic' || github.event.inputs.test_type == 'secrets' || github.event.inputs.test_type == 'opentofu'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Check repository structure
        run: |
          echo "## ðŸ“ Repository Structure" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          echo "## ðŸ—ï¸ Infrastructure Directory" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la infrastructure/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Check workflow files
        run: |
          echo "## ðŸ”„ Workflow Files" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la .github/workflows/ >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  secrets-test:
    name: ðŸ” Secrets Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'secrets' || github.event.inputs.test_type == 'opentofu'
    
    steps:
      - name: ðŸ” Check DigitalOcean token
        run: |
          echo "## ðŸ” Secrets Check" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.DIGITALOCEAN_TOKEN }}" ]; then
            echo "âœ… DIGITALOCEAN_TOKEN is set" >> $GITHUB_STEP_SUMMARY
            echo "Token length: ${#DO_TOKEN} characters" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ DIGITALOCEAN_TOKEN is not set" >> $GITHUB_STEP_SUMMARY
            echo "Please add your DigitalOcean token to repository secrets" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          DO_TOKEN: ${{ secrets.DIGITALOCEAN_TOKEN }}

  opentofu-test:
    name: ðŸ—ï¸ OpenTofu Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'opentofu'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: "1.8.2"

      - name: ðŸ” Test OpenTofu installation
        run: |
          echo "## ðŸ—ï¸ OpenTofu Installation" >> $GITHUB_STEP_SUMMARY
          tofu version >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” Validate infrastructure configuration
        run: |
          cd infrastructure
          echo "## ðŸ“‹ OpenTofu Validation" >> $GITHUB_STEP_SUMMARY
          
          # Initialize without backend
          tofu init -backend=false
          
          # Validate configuration
          if tofu validate; then
            echo "âœ… Infrastructure configuration is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Infrastructure configuration has errors" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Format check
          if tofu fmt -check -recursive; then
            echo "âœ… Code formatting is correct" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Code formatting needs adjustment" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ” Test with secrets (dry run)
        run: |
          cd infrastructure
          echo "## ðŸ§ª Dry Run Test" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ secrets.DIGITALOCEAN_TOKEN }}" ]; then
            # Test initialization with real token
            export TF_VAR_do_token="${{ secrets.DIGITALOCEAN_TOKEN }}"
            
            if tofu init; then
              echo "âœ… OpenTofu initialization successful" >> $GITHUB_STEP_SUMMARY
              
              # Test plan (dry run)
              if tofu plan -var="cluster_name=test-cluster" -var="node_count=1" -var="node_size=s-1vcpu-1gb"; then
                echo "âœ… OpenTofu plan successful" >> $GITHUB_STEP_SUMMARY
              else
                echo "âŒ OpenTofu plan failed" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "âŒ OpenTofu initialization failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ Cannot test with secrets - DIGITALOCEAN_TOKEN not set" >> $GITHUB_STEP_SUMMARY
          fi
