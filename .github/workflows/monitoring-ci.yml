name: ğŸ“Š Monitoring Stack CI/CD

on:
  push:
    branches: [ main ]
    paths:
      - 'helm/monitoring-stack/**'
      - '.github/workflows/monitoring-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'helm/monitoring-stack/**'

env:
  MONITORING_NAMESPACE: monitoring
  AUTH_NAMESPACE: auth-app

jobs:
  validate-monitoring:
    name: ğŸ” Validate Monitoring Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: ğŸ“Š Add Helm repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: ğŸ” Validate Helm chart
        run: |
          cd helm/monitoring-stack
          helm dependency update
          helm lint .
          helm template monitoring-stack . --debug

      - name: ğŸ§ª Test Helm values
        run: |
          cd helm/monitoring-stack
          helm template monitoring-stack . \
            --set prometheus.enabled=true \
            --set grafana.standalone.enabled=false \
            --dry-run

  deploy-monitoring:
    name: ğŸš€ Deploy Monitoring Stack
    runs-on: ubuntu-latest
    needs: validate-monitoring
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: âš™ï¸ Configure kubectl
        run: |
          # This would be configured with your cluster credentials
          # For now, we'll just validate the manifests
          echo "Kubectl configuration would go here"

      - name: ğŸ“Š Add Helm repositories
        run: |
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: ğŸ—ï¸ Update Helm dependencies
        run: |
          cd helm/monitoring-stack
          helm dependency update

      - name: ğŸš€ Deploy monitoring stack (dry-run)
        run: |
          cd helm/monitoring-stack
          helm upgrade --install monitoring-stack . \
            --namespace ${{ env.MONITORING_NAMESPACE }} \
            --create-namespace \
            --dry-run \
            --debug

      - name: ğŸ“ˆ Generate monitoring report
        run: |
          echo "## ğŸ“Š Monitoring Stack Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Components Deployed:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” Prometheus (metrics collection)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“Š Grafana (visualization)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸš¨ AlertManager (notifications)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“ˆ Node Exporter (system metrics)" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¯ ServiceMonitors (application metrics)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— Access Information:" >> $GITHUB_STEP_SUMMARY
          echo "- **Grafana**: Port-forward to access dashboards" >> $GITHUB_STEP_SUMMARY
          echo "- **Prometheus**: Port-forward to access metrics" >> $GITHUB_STEP_SUMMARY
          echo "- **AlertManager**: Port-forward to manage alerts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Run \`kubectl port-forward -n monitoring svc/monitoring-stack-grafana 3001:80\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Access Grafana at http://localhost:3001" >> $GITHUB_STEP_SUMMARY
          echo "3. Login with admin/admin123 (change in production!)" >> $GITHUB_STEP_SUMMARY
          echo "4. Explore pre-configured dashboards" >> $GITHUB_STEP_SUMMARY

  update-auth-stack:
    name: ğŸ”„ Update Auth-Stack with Monitoring
    runs-on: ubuntu-latest
    needs: deploy-monitoring
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: ğŸ¯ Update auth-stack with monitoring
        run: |
          helm upgrade --install auth-stack helm/auth-stack \
            --namespace ${{ env.AUTH_NAMESPACE }} \
            --set monitoring.enabled=true \
            --set monitoring.serviceMonitor.enabled=true \
            --dry-run \
            --debug

      - name: ğŸ“Š Validate ServiceMonitors
        run: |
          echo "Validating ServiceMonitor configurations..."
          cd helm/auth-stack
          helm template auth-stack . \
            --set monitoring.enabled=true \
            --show-only templates/servicemonitor.yaml

  security-scan:
    name: ğŸ”’ Security Scan Monitoring Images
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Scan Prometheus image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'prom/prometheus:latest'
          format: 'sarif'
          output: 'prometheus-results.sarif'

      - name: ğŸ” Scan Grafana image
        uses: aquasecurity/trivy-action@0.24.0
        with:
          image-ref: 'grafana/grafana:latest'
          format: 'sarif'
          output: 'grafana-results.sarif'

      - name: ğŸ“Š Upload scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: '.'
