name: âš¡ Quick Infrastructure Test

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action'
        required: true
        default: 'validate'
        type: choice
        options:
        - validate
        - plan
        - apply

env:
  TF_VAR_do_token: ${{ secrets.DIGITALOCEAN_TOKEN }}

jobs:
  quick-test:
    name: âš¡ Quick Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.2

      - name: ðŸ” Check Token
        run: |
          if [ -z "$TF_VAR_do_token" ]; then
            echo "âŒ No DigitalOcean token found"
            exit 1
          fi
          echo "âœ… Token is set (${#TF_VAR_do_token} chars)"

      - name: ðŸ“ Check Files
        working-directory: infrastructure
        run: |
          echo "ðŸ“ Infrastructure files:"
          ls -la
          echo ""
          echo "ðŸ“„ main.tf content:"
          head -20 main.tf

      - name: âš¡ Quick Init
        working-directory: infrastructure
        run: |
          echo "âš¡ Starting OpenTofu init..."
          
          # Quick init with timeout
          timeout 120s tofu init -no-color -input=false
          
          if [ $? -eq 124 ]; then
            echo "âŒ Init timed out after 2 minutes"
            exit 1
          fi
          
          echo "âœ… Init completed successfully"

      - name: âœ… Validate
        working-directory: infrastructure
        run: |
          echo "âœ… Validating configuration..."
          tofu validate

      - name: ðŸ“‹ Plan (if requested)
        if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply'
        working-directory: infrastructure
        run: |
          echo "ðŸ“‹ Creating plan..."
          tofu plan -no-color \
            -var="cluster_name=quick-test-${{ github.run_number }}" \
            -var="node_count=1" \
            -var="node_size=s-1vcpu-1gb" \
            -var="region=nyc1" \
            -out=tfplan

      - name: ðŸš€ Apply (if requested)
        if: github.event.inputs.action == 'apply'
        working-directory: infrastructure
        run: |
          echo "ðŸš€ Applying infrastructure..."
          tofu apply -auto-approve -no-color tfplan
          
          echo "ðŸ“Š Outputs:"
          tofu output

      - name: ðŸ“Š Summary
        run: |
          echo "## âš¡ Quick Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.action }}" = "apply" ]; then
            echo "âš ï¸ **IMPORTANT:** Cluster created! Remember to destroy it to avoid charges." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To destroy: Run this workflow again with action 'destroy'" >> $GITHUB_STEP_SUMMARY
          fi

  destroy:
    name: ðŸ’¥ Destroy (if needed)
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy'
    timeout-minutes: 10
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.8.2

      - name: âš¡ Quick Init
        working-directory: infrastructure
        run: |
          timeout 120s tofu init -no-color -input=false

      - name: ðŸ’¥ Destroy
        working-directory: infrastructure
        run: |
          echo "ðŸ’¥ Destroying infrastructure..."
          tofu destroy -auto-approve -no-color \
            -var="cluster_name=quick-test-${{ github.run_number }}" \
            -var="node_count=1" \
            -var="node_size=s-1vcpu-1gb" \
            -var="region=nyc1"
          
          echo "âœ… Infrastructure destroyed"
