# ğŸ“Š **Monitoring Setup Guide: Grafana + Prometheus with Helm**

## ğŸ¯ **Overview**

This guide shows you how to add comprehensive monitoring to your auth-stack application using:
- **Prometheus** - Metrics collection and alerting
- **Grafana** - Beautiful dashboards and visualization
- **AlertManager** - Alert routing and notifications
- **Helm Charts** - Easy deployment and management

---

## ğŸš€ **Quick Start**

### **1. Deploy Monitoring Stack**

```bash
# Make the script executable
chmod +x deploy-monitoring.sh

# Deploy everything
./deploy-monitoring.sh
```

### **2. Access Dashboards**

```bash
# Access Grafana (username: admin, password: admin123)
kubectl port-forward -n monitoring svc/monitoring-stack-grafana 3001:80

# Access Prometheus
kubectl port-forward -n monitoring svc/monitoring-stack-kube-prometheus-prometheus 9090:9090

# Access AlertManager
kubectl port-forward -n monitoring svc/monitoring-stack-kube-prometheus-alertmanager 9093:9093
```

### **3. Open in Browser**

- **Grafana**: http://localhost:3001
- **Prometheus**: http://localhost:9090
- **AlertManager**: http://localhost:9093

---

## ğŸ“Š **What You Get**

### **Pre-configured Dashboards:**
- ğŸ¯ **Auth Stack Application** - Custom dashboard for your app
- ğŸ–¥ï¸ **Kubernetes Cluster Overview** - Cluster health and resources
- ğŸ“ˆ **Node Exporter** - System metrics (CPU, memory, disk)
- ğŸ³ **Docker Containers** - Container metrics and performance

### **Monitoring Targets:**
- âœ… **Backend API** - HTTP requests, response times, errors
- âœ… **Frontend App** - Performance metrics
- âœ… **MariaDB Database** - Connection pools, query performance
- âœ… **Kubernetes Cluster** - Pods, nodes, resources
- âœ… **System Metrics** - CPU, memory, disk, network

### **Alert Rules:**
- ğŸš¨ **Application Down** - Backend/frontend unavailable
- âš¡ **High Response Time** - API performance degradation
- ğŸ’¾ **High Memory Usage** - Resource exhaustion
- ğŸ”¥ **High CPU Usage** - Performance issues

---

## ğŸ”§ **Configuration Files**

### **Helm Chart Structure:**
```
helm/monitoring-stack/
â”œâ”€â”€ Chart.yaml                 # Chart metadata and dependencies
â”œâ”€â”€ values.yaml               # Configuration values
â”œâ”€â”€ dashboards/
â”‚   â””â”€â”€ auth-stack-dashboard.json  # Custom dashboard
â””â”€â”€ templates/
    â””â”€â”€ (generated by dependencies)

helm/auth-stack/
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ servicemonitor.yaml   # Prometheus monitoring config
â””â”€â”€ values.yaml              # Updated with monitoring settings
```

### **Key Configuration:**

**Monitoring Stack** (`helm/monitoring-stack/values.yaml`):
- Prometheus with 30-day retention
- Grafana with pre-configured dashboards
- AlertManager for notifications
- DigitalOcean LoadBalancer for external access

**Auth Stack** (`helm/auth-stack/values.yaml`):
- ServiceMonitor for Prometheus scraping
- Metrics endpoints configuration
- Alert rules for application monitoring

---

## ğŸ“ˆ **Monitoring Metrics**

### **Application Metrics:**
```prometheus
# HTTP Request Rate
rate(http_requests_total{job="auth-backend"}[5m])

# Response Time (95th percentile)
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="auth-backend"}[5m]))

# Error Rate
rate(http_requests_total{job="auth-backend",status=~"5.."}[5m])

# Database Connections
mysql_global_status_threads_connected
```

### **System Metrics:**
```prometheus
# CPU Usage
rate(container_cpu_usage_seconds_total[5m]) * 100

# Memory Usage
container_memory_usage_bytes / 1024 / 1024

# Disk Usage
node_filesystem_avail_bytes / node_filesystem_size_bytes * 100
```

---

## ğŸš¨ **Setting Up Alerts**

### **1. Slack Notifications:**

Add to `values.yaml`:
```yaml
kube-prometheus-stack:
  alertmanager:
    config:
      global:
        slack_api_url: 'YOUR_SLACK_WEBHOOK_URL'
      route:
        group_by: ['alertname']
        receiver: 'slack-notifications'
      receivers:
      - name: 'slack-notifications'
        slack_configs:
        - channel: '#alerts'
          title: 'Alert: {{ .GroupLabels.alertname }}'
          text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
```

### **2. Email Notifications:**

```yaml
kube-prometheus-stack:
  alertmanager:
    config:
      global:
        smtp_smarthost: 'smtp.gmail.com:587'
        smtp_from: 'alerts@yourcompany.com'
      receivers:
      - name: 'email-notifications'
        email_configs:
        - to: 'team@yourcompany.com'
          subject: 'Alert: {{ .GroupLabels.alertname }}'
          body: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
```

---

## ğŸ”„ **CI/CD Integration**

### **Automated Deployment:**

The monitoring stack is integrated into your CI/CD pipeline:

1. **Validation** - Helm charts are linted and tested
2. **Security Scanning** - Container images are scanned
3. **Deployment** - Monitoring stack is deployed automatically
4. **Integration** - Auth-stack is updated with monitoring

### **GitHub Actions Workflow:**

```yaml
# Triggers on changes to monitoring configuration
on:
  push:
    paths:
      - 'helm/monitoring-stack/**'
```

---

## ğŸ› ï¸ **Customization**

### **Add Custom Metrics:**

1. **Update your application** to expose metrics:
```javascript
// In your Express.js backend
const promClient = require('prom-client');
const register = new promClient.Registry();

// Custom metrics
const httpRequestsTotal = new promClient.Counter({
  name: 'http_requests_total',
  help: 'Total HTTP requests',
  labelNames: ['method', 'route', 'status']
});

register.registerMetric(httpRequestsTotal);

// Expose metrics endpoint
app.get('/metrics', (req, res) => {
  res.set('Content-Type', register.contentType);
  res.end(register.metrics());
});
```

2. **Update ServiceMonitor** to scrape your metrics:
```yaml
# Already configured in helm/auth-stack/templates/servicemonitor.yaml
```

### **Create Custom Dashboards:**

1. **Design in Grafana UI**
2. **Export JSON**
3. **Add to** `helm/monitoring-stack/dashboards/`
4. **Update values.yaml** to include the new dashboard

---

## ğŸ” **Troubleshooting**

### **Common Issues:**

**Prometheus not scraping targets:**
```bash
# Check ServiceMonitor
kubectl get servicemonitor -n auth-app

# Check Prometheus targets
kubectl port-forward -n monitoring svc/monitoring-stack-kube-prometheus-prometheus 9090:9090
# Visit http://localhost:9090/targets
```

**Grafana dashboards not loading:**
```bash
# Check Grafana logs
kubectl logs -n monitoring deployment/monitoring-stack-grafana

# Restart Grafana
kubectl rollout restart -n monitoring deployment/monitoring-stack-grafana
```

**High resource usage:**
```bash
# Check resource consumption
kubectl top pods -n monitoring

# Adjust resource limits in values.yaml
```

---

## ğŸ“š **Next Steps**

1. **ğŸ¨ Customize Dashboards** - Add your specific business metrics
2. **ğŸš¨ Configure Alerts** - Set up Slack/email notifications
3. **ğŸ“Š Add Log Aggregation** - Consider adding Loki for logs
4. **ğŸ”’ Secure Access** - Set up proper authentication and RBAC
5. **ğŸ“ˆ Scale Monitoring** - Adjust retention and storage as needed

---

## ğŸ‰ **You're All Set!**

Your monitoring stack is now ready to provide comprehensive observability for your auth-stack application. You can monitor performance, track user behavior, and get alerted to issues before they impact users.

**Happy Monitoring!** ğŸ“ŠğŸš€
